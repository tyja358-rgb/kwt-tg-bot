import os
import json
import requests
from analytics.passenger_interest import get_passenger_interest
from dotenv import load_dotenv
from telegram import Update
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext
from openai import OpenAI
from datetime import datetime, timedelta, timezone
import holidays

# ====== –ó–∞–≥—Ä—É–∑–∫–∞ .env ======
load_dotenv()
TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
OPENWEATHER_API_KEY = os.getenv("OPENWEATHER_API_KEY")

# ====== OpenAI client ======
client = OpenAI(api_key=OPENAI_API_KEY)

# ====== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–º—è—Ç–∏ –±–æ—Ç–∞ ======
MEMORY_FILE = "memory/memory.json"
if not os.path.exists("memory"):
    os.makedirs("memory")

if os.path.exists(MEMORY_FILE):
    with open(MEMORY_FILE, "r", encoding="utf-8") as f:
        memory = json.load(f)
else:
    memory = {}

def save_memory():
    with open(MEMORY_FILE, "w", encoding="utf-8") as f:
        json.dump(memory, f, ensure_ascii=False, indent=2)

# ====== –ü–æ–≥–æ–¥–∞ ======
def get_weather(city="Chisinau"):
    url = f"https://api.openweathermap.org/data/2.5/weather?q={city}&appid={OPENWEATHER_API_KEY}&units=metric&lang=ru"
    resp = requests.get(url).json()
    temp = resp["main"]["temp"]
    desc = resp["weather"][0]["description"]
    return temp, desc

# ====== –≠–º–æ–¥–∑–∏ —Å–ø—Ä–æ—Å–∞ ======
def demand_emoji(temp):
    if temp <= 0:
        return "‚ùÑ"
    elif 1 <= temp <= 15:
        return "‚ö°"
    else:
        return "üî•"

# ====== AI –ª–æ–≥–∏–∫–∞ —Å –ø–∞–º—è—Ç—å—é ======
def ask_ai(prompt: str, user_id: str) -> str:
    if user_id not in memory:
        memory[user_id] = []
    memory[user_id].append(prompt)

    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {
                "role": "system",
                "content": (
                    "–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤. "
                    "–¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å —Ä—ã–Ω–æ–∫, —Å–µ–∑–æ–Ω, –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏, –ø–æ–≥–æ–¥—É, –ø—Ä–∞–∑–¥–Ω–∏–∫–∏, "
                    "—ç–∫–æ–Ω–æ–º–∏–∫—É –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π. "
                    "–¢—ã –¥–∞—ë—à—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –∏ —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É —Å–ø—Ä–æ—Å–∞ –Ω–∞ –¥–µ–Ω—å, –Ω–µ–¥–µ–ª—é –∏ –º–µ—Å—è—Ü."
                )
            },
            {"role": "user", "content": prompt}
        ],
        temperature=0.7
    )
    answer = response.choices[0].message.content
    memory[user_id].append(answer)
    save_memory()
    return answer

# ====== –¢–µ–∫—Å—Ç–æ–≤–∞—è —Ç–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ ======
def generate_heatmap():
    temp, weather_desc = get_weather()
    emoji = demand_emoji(temp)

    heatmap = f"üå° –ü–æ–≥–æ–¥–∞ –≤ –ö–∏—à–∏–Ω—ë–≤–µ: {temp:.1f}¬∞C, {weather_desc}\n\n"
    heatmap += "üî•‚ö°‚ùÑ –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ —Å–ø—Ä–æ—Å–∞:\n\n"
    heatmap += f"üëó –û–¥–µ–∂–¥–∞ –∏ –æ–±—É–≤—å: {emoji} –ó–∏–º–Ω—è—è –æ–¥–µ–∂–¥–∞, ‚ö° –°–ø–æ—Ä—Ç–∏–≤–Ω–∞—è, ‚ùÑ –õ–µ—Ç–Ω—è—è\n"
    heatmap += f"üì± –≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞: {emoji} –°–º–∞—Ä—Ç—Ñ–æ–Ω—ã, ‚ö° –ù–∞—É—à–Ω–∏–∫–∏, ‚ùÑ –ö–æ–º–ø—å—é—Ç–µ—Ä—ã\n"
    heatmap += f"üè† –¢–æ–≤–∞—Ä—ã –¥–ª—è –¥–æ–º–∞: {emoji} –û–±–æ–≥—Ä–µ–≤–∞—Ç–µ–ª–∏, ‚ö° –ü–æ—Å—Ç–µ–ª—å, ‚ùÑ –ö—É—Ö–Ω—è\n"
    heatmap += f"üèãÔ∏è –°–ø–æ—Ä—Ç: {emoji} –ó–∏–º–Ω–∏–µ –≤–∏–¥—ã —Å–ø–æ—Ä—Ç–∞, ‚ö° –°–ø–æ—Ä—Ç–∏–≤–Ω–∞—è –æ–±—É–≤—å, ‚ùÑ –í–µ–ª–æ—Å–∏–ø–µ–¥—ã\n"
    heatmap += f"üíÑ –ö—Ä–∞—Å–æ—Ç–∞: {emoji} –£–≤–ª–∞–∂–Ω–µ–Ω–∏–µ, ‚ö° –ü–∞—Ä—Ñ—é–º–µ—Ä–∏—è, ‚ùÑ –õ–µ—Ç–Ω—è—è –∫–æ—Å–º–µ—Ç–∏–∫–∞\n"
    heatmap += f"ü•¶ –ü—Ä–æ–¥—É–∫—Ç—ã: {emoji} –ó–∏–º–Ω–∏–µ —Ñ—Ä—É–∫—Ç—ã, ‚ö° –ó–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–µ, ‚ùÑ –°–≤–µ–∂–∏–µ –æ–≤–æ—â–∏\n"

    try:
        passenger = get_passenger_interest()
        if passenger.get("total_ads", 0) == 0:
            raise ValueError("–î–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã")
        heatmap += (
            "\nüöê –ü–∞—Å—Å–∞–∂–∏—Ä–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∏ (–ú–æ–ª–¥–æ–≤–∞):\n"
            f"–û–±—ä—è–≤–ª–µ–Ω–∏–π: {passenger['total_ads']}\n"
            f"–°–≤–µ–∂–∏–µ: {passenger['fresh_ads']}\n"
            f"–ü—Ä–æ—Å–º–æ—Ç—Ä—ã: {passenger['views']}\n"
            f"–ò–Ω—Ç–µ—Ä–µ—Å: üî• {passenger['interest_score']}\n"
        )
    except Exception:
        heatmap += "\nüöê –ü–∞—Å—Å–∞–∂–∏—Ä–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∏: –¥–∞–Ω–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã\n"

    return heatmap

# ====== Google Calendar ======
from googleapiclient.discovery import build
from google.oauth2 import service_account

SERVICE_ACCOUNT_FILE = 'google_keys/aetherium-486700-61a4b74e3f1c.json'
SCOPES = ['https://www.googleapis.com/auth/calendar']
CALENDAR_ID = 'primary'

credentials = service_account.Credentials.from_service_account_file(
    SERVICE_ACCOUNT_FILE, scopes=SCOPES
)
calendar_service = build('calendar', 'v3', credentials=credentials)

def add_calendar_event(summary: str, description: str, start_in_minutes: int = 1, duration_minutes: int = 60):
    start_time = datetime.now(timezone.utc) + timedelta(minutes=start_in_minutes)
    end_time = start_time + timedelta(minutes=duration_minutes)

    event = {
        'summary': summary,
        'description': description,
        'start': {'dateTime': start_time.isoformat(), 'timeZone': 'Europe/Chisinau'},
        'end': {'dateTime': end_time.isoformat(), 'timeZone': 'Europe/Chisinau'},
    }

    created_event = calendar_service.events().insert(calendarId=CALENDAR_ID, body=event).execute()
    return f"–°–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–æ: {created_event.get('htmlLink')}"

# ====== Telegram handlers ======
def start(update: Update, context: CallbackContext):
    update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! –Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞–º.\n"
        "–°–ø—Ä–æ—Å–∏ –º–µ–Ω—è –æ —Ç–æ–≤–∞—Ä–∞—Ö –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—ã:\n"
        "/today - —Å–ø—Ä–æ—Å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è\n"
        "/week - —Å–ø—Ä–æ—Å –Ω–∞ –Ω–µ–¥–µ–ª—é\n"
        "/month - —Å–ø—Ä–æ—Å –Ω–∞ –º–µ—Å—è—Ü\n"
        "/addevent –ù–∞–∑–≤–∞–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ - –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å"
    )

def handle_message(update: Update, context: CallbackContext):
    user_text = update.message.text
    user_id = str(update.message.from_user.id)

    try:
        today_date = datetime.now()
        day_of_week = today_date.strftime("%A")
        year = today_date.year
        md_holidays = holidays.Moldova(years=year)
        holiday_today = today_date in md_holidays
        temp, weather_desc = get_weather()
        extra_info = (
            f"–°–µ–≥–æ–¥–Ω—è: {today_date.strftime('%d.%m.%Y')} ({day_of_week})\n"
            f"–ü–æ–≥–æ–¥–∞: {temp}¬∞C, {weather_desc}\n"
            f"{'–ü—Ä–∞–∑–¥–Ω–∏–∫!' if holiday_today else ''}"
        )

        prompt = f"{extra_info}\n–í–æ–ø—Ä–æ—Å: {user_text}"
        answer = ask_ai(prompt, user_id)
        update.message.reply_text(answer)
    except Exception as e:
        update.message.reply_text(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {e}")

def today(update: Update, context: CallbackContext):
    update.message.reply_text(generate_heatmap())

def week(update: Update, context: CallbackContext):
    update.message.reply_text(generate_heatmap())

def month(update: Update, context: CallbackContext):
    update.message.reply_text(generate_heatmap())

def addevent(update: Update, context: CallbackContext):
    try:
        args = update.message.text.split(" ", 1)
        if len(args) < 2 or "|" not in args[1]:
            update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /addevent –ù–∞–∑–≤–∞–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ")
            return
        summary, description = map(str.strip, args[1].split("|", 1))
        link = add_calendar_event(summary, description)
        update.message.reply_text(link)
    except Exception as e:
        update.message.reply_text(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è: {e}")

# ====== –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ ======
def main():
    updater = Updater(token=TELEGRAM_BOT_TOKEN, use_context=True)
    dp = updater.dispatcher

    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(CommandHandler("today", today))
    dp.add_handler(CommandHandler("week", week))
    dp.add_handler(CommandHandler("month", month))
    dp.add_handler(CommandHandler("addevent", addevent))
    dp.add_handler(MessageHandler(Filters.text & ~Filters.command, handle_message))

    updater.start_polling()
    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω")
    updater.idle()

if __name__ == "__main__":
    main()
