import os
import re
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from bot_sender import send_message
BASE_URL = "https://999.md/ru/list/real-estate/apartments-and-rooms?o_16_1=912"
def load_sent_links():
    if not os.path.exists("sent_links.txt"):
        return set()
    with open("sent_links.txt", "r") as f:
        return set(f.read().splitlines())
def save_sent_link(link):
    with open("sent_links.txt", "a") as f:
        f.write(link + "\n")
def create_driver():
    chrome_options = Options()
    chrome_options.add_argument("--headless=new")
    chrome_options.add_argument("--no-sandbox")
    chrome_options.add_argument("--disable-dev-shm-usage")
    chrome_options.add_argument("--window-size=1920,1080")
    chrome_options.add_argument("--disable-blink-features=AutomationControlled")
    driver = webdriver.Chrome(options=chrome_options)
    return driver
def run_parser():
    sent_links = load_sent_links()
    driver = create_driver()
    driver.get(BASE_URL)
    wait = WebDriverWait(driver, 20)
    # Ждём загрузки карточек объявлений
    wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, "a[href^='/ru/']")))
    # Прокрутка вниз чтобы прогрузились элементы
    driver.execute_script("window.scrollTo(0, document.body.scrollHeight);")
    time.sleep(3)
    links = driver.find_elements(By.CSS_SELECTOR, "a[href^='/ru/']")
    new_links_found = False
    for link in links:
        href = link.get_attribute("href")
        if not href:
            continue
        # Ищем строго объявления вида /ru/87410250
        match = re.match(r"https://999\.md/ru/(\d+)$", href)
        if match:
            if href not in sent_links:
                print("Новая ссылка:", href)
                send_message(href)
                save_sent_link(href)
                new_links_found = True
                time.sleep(1)
    driver.quit()
    if not new_links_found:
        print("Новых объявлений нет")
if __name__ == "__main__":
    while True:
        print("Запуск парсинга...")
        run_parser()
        print("Ждём 2 часа...")
        time.sleep(7200)
(venv) root@vmi3077942:~/project/parser_project#
