from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Updater, CommandHandler, CallbackContext, CallbackQueryHandler
import requests

TOKEN = "8389490742:AAGXDGWxGCdREk4peI3I8fPU1cGMBpdaHvM"
API_URL = "https://Moldova2026.pythonanywhere.com"

def start(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    requests.post(f"{API_URL}/join", json={
        "user_id": user_id
    })
    update.message.reply_text(
        "‚ö°Ô∏è –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ LET Energy\n"
        "–¢—ã –ø–æ–¥–∫–ª—é—á—ë–Ω –∫ –æ–±—â–µ–π —ç–Ω–µ—Ä–≥–æ—Å–µ—Ç–∏.\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/pool ‚Äî –æ–±—â–∏–π –ø—É–ª —ç–Ω–µ—Ä–≥–∏–∏\n"
        "/play ‚Äî –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É\n"
        "/press ‚Äî –≤—ã–±—Ä–∞—Ç—å –∫–Ω–æ–ø–∫—É"
    )

def pool(update: Update, context: CallbackContext):
    r = requests.get(f"{API_URL}/pool").json()
    update.message.reply_text(
        f"üîã –û–±—â–∏–π –ø—É–ª —ç–Ω–µ—Ä–≥–∏–∏: {r['LET_pool']} LET"
    )

def play(update: Update, context: CallbackContext):
    update.message.reply_text(
        "üéÆ –ò–≥—Ä–∞ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞.\n"
        "–°–µ–π—á–∞—Å –º—ã –ø–æ–¥–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏."
    )

# ======= –î–û–ë–ê–í–õ–ï–ù–û: –∫–æ–º–∞–Ω–¥–∞ /press —Å –∫–Ω–æ–ø–∫–∞–º–∏ =======
def press(update: Update, context: CallbackContext):
    user_id = update.effective_user.id

    keyboard = []
    for i in range(1, 31):
        keyboard.append([InlineKeyboardButton(str(i), callback_data=str(i))])

    reply_markup = InlineKeyboardMarkup(keyboard)
    update.message.reply_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–Ω–æ–ø–∫—É (1‚Äì30):",
        reply_markup=reply_markup
    )

def button_callback(update, context):
    query = update.callback_query
    query.answer()

    user_id = query.from_user.id
    button = int(query.data)

    r = requests.post(f"{API_URL}/click", json={
        "user_id": user_id,
        "button": button
    }).json()

    query.edit_message_text(
        text=r["message"] + f"\nüîã –û–±—â–∏–π –ø—É–ª: {r.get('pool', r.get('energy'))} LET"
    )
# ================================================

def main():
    updater = Updater(TOKEN)
    dp = updater.dispatcher

    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(CommandHandler("pool", pool))
    dp.add_handler(CommandHandler("play", play))

    # ======= –î–û–ë–ê–í–õ–ï–ù–û: –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ =======
    dp.add_handler(CommandHandler("press", press))
    dp.add_handler(CallbackQueryHandler(button_callback))
    # ============================================

    updater.start_polling()
    updater.idle()

if __name__ == "__main__":
    main()
