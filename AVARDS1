function openPointModal(point){
    activePoint = point;
    point.adsViewed = 0; // сброс просмотров для этой точки

    const modal = document.getElementById('point-modal');
    modal.style.display = 'flex';

    const dist = distance(playerLat, playerLng, point.lat, point.lng);

    let power = 0;
    if(dist >= 100) power = Math.floor((dist - 100)/100 + 1) * 4;

    const adsRequired = Math.max(1, Math.ceil(dist / 100));

    point.power = power;
    point.adsRequired = adsRequired;

    document.getElementById('pm-info').innerHTML =
        `Расстояние: ${dist.toFixed(1)} м<br>
         Нужно рекламы: ${point.adsRequired}<br>
         Мощность: ${point.power.toFixed(1)} ват`;
    document.getElementById('ads-count').textContent = point.adsViewed;

    const adBtn = document.getElementById('pm-ad-btn');
    adBtn.onclick = ()=>{
        point.adsViewed++;
        document.getElementById('ads-count').textContent = point.adsViewed;

        if(point.adsViewed >= point.adsRequired){
            // начинаем движение к точке перед сбором
            movePlayerToPoint(point, ()=>collectPoint(point, "через просмотр рекламы"));
        }
    };
}

// Функция движения игрока к точке
function movePlayerToPoint(point, callback){
    const speed = 0.00005; // скорость движения (можно подстроить)
    let moveInterval = setInterval(()=>{
        const dx = point.lng - playerLng;
        const dy = point.lat - playerLat;
        const dist = Math.hypot(dx, dy);

        if(dist < 0.00005){ // дошли до точки
            clearInterval(moveInterval);
            if(callback) callback();
            return;
        }

        // нормализуем движение
        playerLat += dy * speed / dist;
        playerLng += dx * speed / dist;
        userMarker.setLatLng([playerLat, playerLng]);
        map.setView([playerLat, playerLng], map.getZoom(), {animate:false});
    }, 50);
}

// Сбор точки (не меняем)
function collectPoint(point, reason=""){
    if(point.collected) return;
    point.collected = true;

    playerPower += point.power;
    document.getElementById('power-total').textContent = playerPower.toFixed(1);
    savePlayerPower();

    if(point.marker) map.removeLayer(point.marker);

    closePointModal(true);
    alert(`Точка собрана ${reason}! Получено ${point.power.toFixed(1)} ват`);
}

// Закрытие модального окна (сбор автоматом)
function closePointModal(autoCollect=false){
    if(activePoint && !activePoint.collected){
        if(autoCollect || activePoint.adsViewed >= activePoint.adsRequired){
            movePlayerToPoint(activePoint, ()=>collectPoint(activePoint, "автоматически при закрытии"));
        }
    }

    document.getElementById('point-modal').style.display = 'none';
    activePoint = null;
}
