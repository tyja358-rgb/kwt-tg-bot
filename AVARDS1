from flask import Flask, render_template, request, jsonify
import os
from werkzeug.utils import secure_filename

app = Flask(__name__)
UPLOAD_FOLDER = 'static/uploads'
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER

# Список фото и голосов (в памяти)
photos = []
votes = {}

# Главная страница
@app.route('/')
def index():
    return render_template('index.html')

# Загрузка фото
@app.route('/upload', methods=['POST'])
def upload_photo():
    if 'photo' not in request.files:
        return jsonify({'status': 'error', 'message': 'Нет файла'})
    file = request.files['photo']
    category = request.form.get('category', 'Без категории')
    username = request.form.get('username', 'Аноним')
    if file.filename == '':
        return jsonify({'status': 'error', 'message': 'Пустой файл'})
    filename = secure_filename(file.filename)
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    file.save(filepath)
    photo_id = len(photos)
    photos.append({'id': photo_id, 'filename': filename, 'category': category, 'username': username})
    votes[photo_id] = 0
    return jsonify({'status': 'ok', 'photo_id': photo_id})

# Получение списка фото для ленты
@app.route('/photos')
@app.route('/photos/<category>')
def get_photos(category=None):
    result = [p for p in photos if (category in [None, '', p['category']])]
    return jsonify(result)

if __name__ == "__main__":
    app.run(debug=True)
