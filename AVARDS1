<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>KWT Mini App Prototype</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
html, body { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; background:#12001f; color:#fff; touch-action: manipulation; }
h1 { text-align:center; margin:10px 0; }
#map { width:100%; height:60vh; display:none; border:2px solid gold; }
.controls { text-align:center; margin:5px; }
.btn { margin:5px; padding:10px 20px; background:#4CAF50; color:white; border:none; cursor:pointer; }
#message { color:#6cff6c; font-weight:bold; text-align:center; margin-top:10px; }
#joystick-container { position:fixed; bottom:30px; left:50%; transform:translateX(-50%); width:160px; height:160px; border-radius:50%; background:rgba(255,255,255,0.1); display:flex; justify-content:center; align-items:center; touch-action:none; z-index:10000; }
#joystick { width:80px; height:80px; border-radius:50%; background:rgba(255,255,255,0.4); position:relative; touch-action:none; }
#splash-img { position:fixed; inset:0; width:100vw; height:100vh; object-fit:cover; z-index:9999; }
.watt-counter {
    position: absolute;
    color: gold;
    font-weight: bold;
    font-size: 14px;
    text-shadow: 0 0 3px #000;
    pointer-events: none;
    transition: transform 0.1s linear;
}
</style>
</head>
<body>
<h1>KWT Mini App Prototype</h1>
<div class="controls">
    <button id="watch-ad-btn" class="btn">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∫–ª–∞–º—É</button>
    <p>–ú–æ—â–Ω–æ—Å—Ç—å –≤ –∫–∞–±–∏–Ω–µ—Ç–µ: <span id="power-total">0</span> –≤–∞—Ç</p>
    <p>üí∞ –ö—ç—à: <span id="cash-total">0</span></p> <!-- üíõ –¢—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—ç—à -->
    <p>üîã –ú–æ–∏ —Å—Ç–∞–Ω—Ü–∏–∏: <span id="stations-count">0</span></p> <!-- üíõ –¢—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–≤–æ–∏—Ö —Å—Ç–∞–Ω—Ü–∏–π -->
</div>
<p id="message"></p>
<div id="map"></div>
<div id="joystick-container"><div id="joystick"></div></div>
<img id="splash-img" src="https://via.placeholder.com/500x500.png?text=KWT+Splash">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const baseLat = 47.0100, baseLng = 28.8638;
let playerLat = baseLat, playerLng = baseLng, playerPower = 0, playerAds = 0;
const STEP_DEGREE = (100 / 111320) / 1200;
let moveX = 0, moveY = 0;
let map, userMarker, points = [], activePoint = null, movingToPoint = false;
let playerCash = 0; // üíõ –ö—ç—à –∏–≥—Ä–æ–∫–∞
let myStationsCount = 0; // üíõ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–≤–æ–∏—Ö —Å—Ç–∞–Ω—Ü–∏–π

// --- ID –∏–≥—Ä–æ–∫–∞ ---
let playerId;
if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
    playerId = window.Telegram.WebApp.initDataUnsafe.user.id;
} else playerId = 123456;

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–æ—â–Ω–æ—Å—Ç–∏
async function loadPlayerPower() {
    try {
        const resp = await fetch(`/player/${playerId}`);
        if (resp.ok) {
            const data = await resp.json();
            playerPower = data.power || 0;
            document.getElementById('power-total').textContent = playerPower.toFixed(1);
        }
    } catch(e){ console.error(e); }
}

async function savePlayerPower() {
    try {
        await fetch(`/player/${playerId}`, {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ power: playerPower })
        });
    } catch(e){ console.error(e); }
}

// ===== –†–∞—Å—á—ë—Ç –º–æ—â–Ω–æ—Å—Ç–∏ —Ç–æ—á–∫–∏ =====
function calculatePower(distMeters){
    if(distMeters < 100) return 0; // –¥–æ 100 –º ‚Äî –º–æ—â–Ω–æ—Å—Ç—å 0
    const hundreds = Math.floor((distMeters - 1)/100); // 100-199 -> 1 —Å–æ—Ç–Ω—è, 200-299 -> 2 —Å–æ—Ç–Ω–∏
    return hundreds * 4; // 4 –≤–∞—Ç –∑–∞ –∫–∞–∂–¥—É—é —Å–æ—Ç–Ω—é –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π
}

// ===== –†–∞—Å—Å—á—ë—Ç —Ä–µ–∫–ª–∞–º—ã =====
function calculateAds(distMeters){
    return Math.floor(distMeters / 100) + 1; // 0-100 –º -> 1 —Ä–µ–∫–ª–∞–º–∞, 101-200 -> 2, 201-300 -> 3
}

// ===== Splash + –∫–∞—Ä—Ç–∞ =====
async function showSplashThenMap(){
    const splash = document.getElementById('splash-img');
    splash.style.display='block';
    setTimeout(async ()=>{
        splash.style.display='none';
        const mapDiv = document.getElementById('map');
        mapDiv.style.display='block';
        await loadPlayerPower();
        initMap();
        map.setView([playerLat, playerLng], 15);
    },3000);
}

// ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã =====
function initMap(){
    map = L.map('map').setView([playerLat, playerLng], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(map);
    userMarker = L.marker([playerLat,playerLng]).addTo(map).bindPopup("–í—ã –∑–¥–µ—Å—å").openPopup();

    generatePoints();
    loadStations();

    map.invalidateSize(); // –¥–æ–±–∞–≤–ª—è–µ–º —á—Ç–æ–±—ã –∫–∞—Ä—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∞—Å—å
} // <- –≤–æ—Ç –∑–∞–∫—Ä—ã–ª–∏ —Ñ—É–Ω–∫—Ü–∏—é initMap


// ===== –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ—á–µ–∫ =====
function generatePoints() {
    points=[];
    const TOTAL_POINTS=50, COLORS=['#00ff99','#ffd700','#ff5555','#00aaff','#cc66ff'];
    for(let i=0;i<TOTAL_POINTS;i++){
        const distMeters=Math.random()*1000+50;
        const distDeg=distMeters/111320;
        const angle=Math.random()*Math.PI*2;
        const lat=baseLat+distDeg*Math.cos(angle);
        const lng=baseLng+distDeg*Math.sin(angle);
        const marker=L.circleMarker([lat,lng],{radius:6,color:COLORS[i%COLORS.length],fillOpacity:0.9}).addTo(map);
        const point={lat,lng,marker,collected:false,power:calculatePower(distMeters),adsRequired:1};
        points.push(point);
        marker.on('click', ()=> openPointModal(point));
    }
}

// ===== –°—Ç–∞–Ω—Ü–∏–∏ —Å DivIcon —Å—á—ë—Ç—á–∏–∫–æ–º =====
let stationMarkers={}, stationsData={};

function loadStations(){
    fetch("/stations")
    .then(r=>r.json())
    .then(stations=>{
        stations.forEach(s=>{
            if(stationMarkers[s.id]) return;

            stationsData[s.id] = { owner:s.owner, power:s.power, rate:s.rate||0.1, lastCollected:s.lastCollected||0, displayedPower:0 };

            // –°–æ–∑–¥–∞–µ–º DivIcon —Å –ø—É—Å—Ç—ã–º —Å—á–µ—Ç—á–∏–∫–æ–º
            const iconHtml = `<div style="position:relative; text-align:center;">
                <div id="counter-${s.id}" style="color:gold; font-weight:bold; font-size:14px; text-shadow:0 0 3px #000;">0.0</div>
                <img src="https://cdn-icons-png.flaticon.com/512/428/428734.png" style="width:24px; height:24px; display:block; margin:0 auto;">
            </div>`;

            const icon = L.divIcon({
                html: iconHtml,
                className: '',  // –±–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ —Ñ–æ–Ω–∞ –º–∞—Ä–∫–µ—Ä–∞
                iconSize: [30, 40],
                iconAnchor: [15, 40] // —Ç–æ—á–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –º–∞—Ä–∫–µ—Ä—É (–Ω–∏–∂–µ —Ü–µ–Ω—Ç—Ä–∞)
            });

            const marker = L.marker([s.lat, s.lng], { icon: icon }).addTo(map);

            marker.bindPopup(`<b>–°—Ç–∞–Ω—Ü–∏—è</b><br>–í–ª–∞–¥–µ–ª–µ—Ü: ${s.owner}<br>–≠–Ω–µ—Ä–≥–∏—è: ${s.power.toFixed(1)}<br>${s.owner==playerId?'<button onclick="collectStation('+s.id+')">–°–æ–±—Ä–∞—Ç—å</button>':'<i>–ß—É–∂–∞—è —Å—Ç–∞–Ω—Ü–∏—è</i>'}`);

            stationMarkers[s.id] = marker;
        });

        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤
        requestAnimationFrame(updateWattCounters);
    });
}

// ===== –ü–ª–∞–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∞—Ç—Ç –¥–ª—è DivIcon =====
function updateWattCounters(){
    for(const id in stationsData){
        const st = stationsData[id];
        st.displayedPower += (st.power - st.displayedPower) * 0.1;
        const counter = document.getElementById(`counter-${id}`);
        if(counter) counter.textContent = st.displayedPower.toFixed(1);
    }
    requestAnimationFrame(updateWattCounters);
}

// ===== –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ (—Å—Ç–∞–Ω—Ü–∏–∏, –¥–∂–æ–π—Å—Ç–∏–∫, —Ç–æ—á–∫–∏, —Ä–µ–∫–ª–∞–º–∞) =====
setInterval(()=>{
    const now=Date.now();
    for(const id in stationsData){
        const st=stationsData[id];
        st.power+=st.rate;
        if(stationMarkers[id]){
            stationMarkers[id].bindPopup(`<b>–°—Ç–∞–Ω—Ü–∏—è</b><br>–í–ª–∞–¥–µ–ª–µ—Ü: ${st.owner}<br>–≠–Ω–µ—Ä–≥–∏—è: ${st.power.toFixed(1)}<br>${st.owner==playerId?'<button onclick="collectStation('+id+')">–°–æ–±—Ä–∞—Ç—å</button>':'<i>–ß—É–∂–∞—è —Å—Ç–∞–Ω—Ü–∏—è</i>'}`);
        }
    }
},1000);

function collectStation(id){
    const st=stationsData[id];
    const now=Date.now();
    if(st.lastCollected && (now-st.lastCollected<24*3600*1000)){ alert("–°–æ–±—Ä–∞—Ç—å –º–æ–∂–Ω–æ —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏!"); return; }
    fetch("/station/collect",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({station_id:id,player_id:playerId,power:st.power})
    }).then(r=>r.json()).then(data=>{
        alert("–°–æ–±—Ä–∞–Ω–æ: "+st.power.toFixed(1));
        st.power=0; st.lastCollected=now;
        savePlayerPower();
    });
}

// ===== –î–∂–æ–π—Å—Ç–∏–∫ =====
const joystick=document.getElementById('joystick'), container=document.getElementById('joystick-container');
let dragging=false;
function updateVector(dx,dy){ const len=Math.hypot(dx,dy); if(len===0){moveX=0; moveY=0; return;} moveX=(dx/len)*STEP_DEGREE; moveY=(-dy/len)*STEP_DEGREE; }
joystick.addEventListener('pointerdown',()=>dragging=true);
document.addEventListener('pointerup',()=>{ dragging=false; joystick.style.transform='translate(0,0)'; updateVector(0,0); });
document.addEventListener('pointermove',e=>{ if(!dragging) return; const r=container.getBoundingClientRect(); const cx=r.left+r.width/2, cy=r.top+r.height/2; let dx=e.clientX-cx, dy=e.clientY-cy; const max=r.width/2-40, dist=Math.min(Math.hypot(dx,dy),max), ang=Math.atan2(dy,dx); dx=dist*Math.cos(ang); dy=dist*Math.sin(ang); joystick.style.transform=`translate(${dx}px,${dy}px)`; updateVector(dx,dy); });

setInterval(()=>{
    if(movingToPoint && activePoint){
        const d=distance(playerLat,playerLng,activePoint.lat,activePoint.lng);
        if(d<5){ activePoint.collected=true; playerPower+=activePoint.power; document.getElementById('power-total').textContent=playerPower.toFixed(1); savePlayerPower(); map.removeLayer(activePoint.marker); movingToPoint=false; activePoint=null; }
        else{ const dx=activePoint.lng-playerLng, dy=activePoint.lat-playerLat, dist=Math.hypot(dx,dy), speed=0.02; playerLat+=(dy/dist)*STEP_DEGREE*1200*speed; playerLng+=(dx/dist)*STEP_DEGREE*1200*speed; userMarker.setLatLng([playerLat,playerLng]); map.setView([playerLat,playerLng], map.getZoom(),{animate:false}); }
    }else{ playerLat+=moveY; playerLng+=moveX; userMarker.setLatLng([playerLat,playerLng]); map.setView([playerLat,playerLng], map.getZoom(),{animate:false}); }
},50);

document.getElementById('watch-ad-btn').onclick=()=>{
    playerAds++;
    for(const p of points){
        if(p.collected) continue;
        const d=distance(playerLat,playerLng,p.lat,p.lng);
        if(d<15 && playerAds>=p.adsRequired){ p.collected=true; playerPower+=p.power; document.getElementById('power-total').textContent=playerPower.toFixed(1); savePlayerPower(); map.removeLayer(p.marker); }
    }
};

function distance(lat1,lon1,lat2,lon2){ const R=6371000; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180; const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2; return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }

function openPointModal(point){
    activePoint = point;
    point.adsViewed = 0; // —Å–±—Ä–æ—Å –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –¥–ª—è —ç—Ç–æ–π —Ç–æ—á–∫–∏

    const modal = document.getElementById('point-modal');
    modal.style.display = 'flex';

    const dist = distance(playerLat, playerLng, point.lat, point.lng);

    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –º–æ—â–Ω–æ—Å—Ç—å —Ç–æ—á–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä 310 –º -> 12 –≤–∞—Ç)
    let power = 0;
    if(dist >= 100) power = Math.floor((dist - 100)/100 + 1) * 4;

    const adsRequired = Math.max(1, Math.ceil(dist / 100));

    point.power = power;
    point.adsRequired = adsRequired;

    document.getElementById('pm-info').innerHTML =
        `–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${dist.toFixed(1)} –º<br>
         –ù—É–∂–Ω–æ —Ä–µ–∫–ª–∞–º—ã: ${point.adsRequired}<br>
         –ú–æ—â–Ω–æ—Å—Ç—å: ${point.power.toFixed(1)} –≤–∞—Ç`;
    document.getElementById('ads-count').textContent = point.adsViewed;

    const adBtn = document.getElementById('pm-ad-btn');
    adBtn.onclick = ()=>{
        point.adsViewed++;
        document.getElementById('ads-count').textContent = point.adsViewed;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏ –ª–∏–º–∏—Ç —Ä–µ–∫–ª–∞–º—ã
        if(point.adsViewed >= point.adsRequired){
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            modal.style.display = 'none';
            activePoint = null;

            // –ó–∞–ø—É—Å–∫–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –∫ —Ç–æ—á–∫–µ –∏ —Å–±–æ—Ä
            movePlayerToPoint(point, ()=>collectPoint(point, "—á–µ—Ä–µ–∑ –ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∫–ª–∞–º—ã"));
        }
    };
}

// –î–≤–∏–≥–∞–µ–º –∏–≥—Ä–æ–∫–∞ –∫ —Ç–æ—á–∫–µ
function movePlayerToPoint(point, callback){
    const speed = 0.00005; // —Å–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è
    const moveInterval = setInterval(()=>{
        const dx = point.lng - playerLng;
        const dy = point.lat - playerLat;
        const dist = Math.hypot(dx, dy);

        if(dist < 0.00005){ // –¥–æ—à–ª–∏ –¥–æ —Ç–æ—á–∫–∏
            clearInterval(moveInterval);
            if(callback) callback();
            return;
        }

        playerLat += dy * speed / dist;
        playerLng += dx * speed / dist;
        userMarker.setLatLng([playerLat, playerLng]);
        map.setView([playerLat, playerLng], map.getZoom(), {animate:false});
    }, 50);
}

// –°–±–æ—Ä —Ç–æ—á–∫–∏
function collectPoint(point, reason=""){
    if(point.collected) return;
    point.collected = true;

    playerPower += point.power;
    document.getElementById('power-total').textContent = playerPower.toFixed(1);
    savePlayerPower();

    if(point.marker) map.removeLayer(point.marker);

    alert(`–¢–æ—á–∫–∞ —Å–æ–±—Ä–∞–Ω–∞ ${reason}! –ü–æ–ª—É—á–µ–Ω–æ ${point.power.toFixed(1)} –≤–∞—Ç`);
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—Ä—É—á–Ω—É—é (–Ω–∏—á–µ–≥–æ –Ω–µ —Å–æ–±–∏—Ä–∞–µ–º)
function closePointModal(){
    document.getElementById('point-modal').style.display = 'none';
    activePoint = null;
}




showSplashThenMap();
</script>

<div id="point-modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.7); display:none; align-items:center; justify-content:center; z-index:20000;">
  <div style="background:#1b002b; padding:20px; border-radius:12px; width:90%; max-width:320px; text-align:center; border:2px solid gold;">
    <h3>üìç –≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∞—è —Ç–æ—á–∫–∞</h3>
    <p id="pm-info">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ—á–∫–µ</p>
    <p>–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ —Ä–µ–∫–ª–∞–º—ã: <span id="ads-count">0</span></p>
    <button class="btn" id="pm-ad-btn">–°–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∫–ª–∞–º—É</button>
    <button class="btn" onclick="closePointModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

</body>
</html>
