from flask import Flask, request, jsonify, render_template, send_from_directory
import os
from werkzeug.utils import secure_filename

app = Flask(__name__)

# Папка для загруженных файлов
UPLOAD_FOLDER = os.path.join(os.getcwd(), 'uploads')
os.makedirs(UPLOAD_FOLDER, exist_ok=True)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER

# Простая "база данных" в памяти для голосования
photos_db = []

# Главная страница
@app.route('/')
def index():
    return render_template('index.html')

# Загрузка фото
@app.route('/upload', methods=['POST'])
def upload():
    file = request.files.get('photo')
    category = request.form.get('category')
    username = request.form.get('username', 'Аноним')

    if not file or not category:
        return jsonify({'status': 'error', 'message': 'Файл или категория не указаны'})

    filename = secure_filename(file.filename)
    filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    file.save(filepath)

    photo_id = len(photos_db) + 1
    photos_db.append({
        'id': photo_id,
        'filename': filename,
        'category': category,
        'username': username,
        'votes': 0
    })

    return jsonify({'status': 'ok', 'photo_id': photo_id})

# Получение фото для ленты голосования
@app.route('/photos')
@app.route('/photos/<category>')
def get_photos(category=None):
    if category:
        filtered = [p for p in photos_db if p['category'] == category]
    else:
        filtered = photos_db
    return jsonify(filtered)

# Статика: доступ к загруженным фото
@app.route('/static/uploads/<filename>')
def uploaded_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

# Для локальной проверки (можно убрать на PythonAnywhere)
if __name__ == "__main__":
    app.run(debug=True)
