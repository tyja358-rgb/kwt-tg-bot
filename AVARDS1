<script>
    let selectedCategory = "";
    let username = "–ê–Ω–æ–Ω–∏–º"; // –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å input, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

    function selectCategory(category) {
        selectedCategory = category;
        document.getElementById("upload-section").style.display = "block";
        alert("–í—ã –≤—ã–±—Ä–∞–ª–∏: " + category);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById('upload-form').addEventListener('submit', function(e){
        e.preventDefault();
        let fileInput = document.getElementById('photo');
        let file = fileInput.files[0];
        if(!file) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!");
        let formData = new FormData();
        formData.append('photo', file);
        formData.append('category', selectedCategory);
        formData.append('username', username);
        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'ok'){
                document.getElementById('message').innerText = "–§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ! ID: " + data.photo_id;
                fileInput.value = "";
                loadGallery();   // –æ–±–Ω–æ–≤–ª—è–µ–º –≥–∞–ª–µ—Ä–µ—é
                loadVoteFeed();  // –æ–±–Ω–æ–≤–ª—è–µ–º –ª–µ–Ω—Ç—É –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
            } else {
                document.getElementById('message').innerText = "–û—à–∏–±–∫–∞: " + data.message;
            }
        })
        .catch(err => {
            console.error(err);
            document.getElementById('message').innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏.";
        });
    });

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥–∞–ª–µ—Ä–µ–∏
    function updateGallery(data) {
        let container = document.getElementById('photos');
        container.innerHTML = ""; // –æ—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º
        data.forEach(photo => {
            let img = document.createElement('img');
            img.src = '/static/uploads/' + photo.filename;
            img.style.width = '150px';
            img.style.margin = '5px';
            container.appendChild(img);
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≥–∞–ª–µ—Ä–µ–∏
    function loadGallery() {
        fetch('/photos')
        .then(res => res.json())
        .then(updateGallery)
        .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–∞–ª–µ—Ä–µ–∏:', err));
    }

    // –§–∏–ª—å—Ç—Ä –≥–∞–ª–µ—Ä–µ–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    document.getElementById('category-filter').addEventListener('change', function() {
        let selected = this.value;
        if(selected === "") {
            fetch('/photos')
            .then(res => res.json())
            .then(updateGallery)
            .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–∞–ª–µ—Ä–µ–∏:', err));
            loadVoteFeed(); // –æ–±–Ω–æ–≤–ª—è–µ–º –ª–µ–Ω—Ç—É –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞
        } else {
            fetch('/photos/' + encodeURIComponent(selected))
            .then(res => res.json())
            .then(updateGallery)
            .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–∞–ª–µ—Ä–µ–∏:', err));
            loadVoteFeed(selected); // –æ–±–Ω–æ–≤–ª—è–µ–º –ª–µ–Ω—Ç—É –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        }
    });

    // –õ–µ–Ω—Ç–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
    function loadVoteFeed(categoryFilter = "") {
        let url = categoryFilter ? '/photos/' + encodeURIComponent(categoryFilter) : '/photos';
        fetch(url)
        .then(res => res.json())
        .then(data => {
            let feed = document.getElementById('vote-feed');
            feed.innerHTML = "";
            data.forEach(photo => {
                let div = document.createElement('div');
                div.className = 'vote-item';
                let img = document.createElement('img');
                img.src = '/static/uploads/' + photo.filename;
                div.appendChild(img);

                // –ö–Ω–æ–ø–∫–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
                let btnDiv = document.createElement('div');
                btnDiv.className = 'vote-buttons';
                let upBtn = document.createElement('button');
                upBtn.innerText = 'üëç';
                let downBtn = document.createElement('button');
                downBtn.innerText = 'üëé';
                btnDiv.appendChild(upBtn);
                btnDiv.appendChild(downBtn);
                div.appendChild(btnDiv);

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤
                upBtn.onclick = () => alert('–í—ã –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞ —Ñ–æ—Ç–æ ID: ' + photo.id);
                downBtn.onclick = () => alert('–í—ã –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –ø—Ä–æ—Ç–∏–≤ —Ñ–æ—Ç–æ ID: ' + photo.id);

                feed.appendChild(div);
            });
        })
        .catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:', err));
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥–∞–ª–µ—Ä–µ—é –∏ –ª–µ–Ω—Ç—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = function() {
        loadGallery();
        loadVoteFeed();
    };
</script>
