<script>
const tg = window.Telegram.WebApp;
tg.expand();

// Скрытый input для фото
const photoInput = document.getElementById("photoInput");
let tempPhoto = null;

photoInput.addEventListener("change", function(event){
    const file = event.target.files[0];
    if(!file) return;
    tempPhoto = file;

    // Автозагрузка на сервер
    const formData = new FormData();
    formData.append("photo", tempPhoto);
    fetch("/upload", { method: "POST", body: formData })
    .then(res => res.json())
    .then(data => {
        tempPhoto = null;
        photoInput.value = "";
        console.log("Фото загружено!");
        alert("Фото загружено на сервер!");
    })
    .catch(err => console.error(err));
});

// Кнопки
document.getElementById("addPhoto").onclick = () => photoInput.click();
document.getElementById("increaseFund").onclick = increaseFund;
document.getElementById("helpShelters").onclick = helpShelters;
document.getElementById("increaseRating").onclick = () => tg.sendData(JSON.stringify({action:"increase_rating"}));

// ======= ЛЕНТА ФОТО (ГОЛОСОВАНИЕ) =======
const voteFeed = document.getElementById("vote-feed");

function openVoteFeed(){
    voteFeed.innerHTML = '<div id="vote-close">&times;</div>'; // крестик
    fetch("/photos")
    .then(res => res.json())
    .then(photos => {
        photos.reverse().forEach(p => {
            const img = document.createElement("img");
            img.src = p; // путь к фото
            img.className = "vote-photo";
            voteFeed.appendChild(img);
        });
        voteFeed.style.display = "flex";
        document.getElementById("main-content").style.display = "none";

        document.getElementById("vote-close").onclick = closeVoteFeed;
    })
    .catch(err => console.error(err));
}

function closeVoteFeed(){
    voteFeed.style.display = "none";
    document.getElementById("main-content").style.display = "block";
}

// Привязка кнопки
document.getElementById("vote").onclick = openVoteFeed;

// ======= ФУНКЦИИ БАРОВ =======
let fundProgress = 0, fundBlocks = 20;
function increaseFund(){
    fundProgress++;
    if(fundProgress > fundBlocks){
        fundProgress = 0;
        document.getElementById("prize-amount").textContent =
            parseInt(document.getElementById("prize-amount").textContent) + 1;
    }
    const fill = document.getElementById("prize-bar-fill"); 
    fill.innerHTML = '';
    for(let i=0;i<fundBlocks;i++){
        let span = document.createElement('span');
        if(i<fundProgress){ setTimeout(()=>{span.style.opacity='1';}, i*50); }
        fill.appendChild(span);
    }
}

let shelterProgress = 0, shelterBlocks = 20;
function helpShelters(){
    shelterProgress++;
    if(shelterProgress > shelterBlocks){
        shelterProgress = 0;
        document.getElementById("shelter-amount").textContent =
            parseInt(document.getElementById("shelter-amount").textContent) + 1;
    }
    const fill = document.getElementById("shelter-bar-fill");
    fill.innerHTML = '';
    for(let i=0;i<shelterBlocks;i++){
        let span = document.createElement('span');
        if(i<shelterProgress){ setTimeout(()=>{span.style.opacity='1';}, i*50); }
        fill.appendChild(span);
    }
}
</script>
