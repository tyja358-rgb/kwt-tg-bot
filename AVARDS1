from flask import Flask, request, jsonify, render_template, send_from_directory
import os
from werkzeug.utils import secure_filename

app = Flask(__name__)

# Папка для загрузок
UPLOAD_FOLDER = 'uploads'
os.makedirs(UPLOAD_FOLDER, exist_ok=True)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER

# Хранилище фото (для теста, в проде лучше база данных)
photos = []
photo_id_counter = 1

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload():
    global photo_id_counter
    if 'photo' not in request.files:
        return jsonify({'status': 'error', 'message': 'Нет файла'}), 400
    file = request.files['photo']
    if file.filename == '':
        return jsonify({'status': 'error', 'message': 'Файл не выбран'}), 400
    
    filename = secure_filename(file.filename)
    file.save(os.path.join(app.config['UPLOAD_FOLDER'], filename))
    
    # Добавляем фото в "базу"
    photo = {
        'id': photo_id_counter,
        'filename': filename,
        'category': request.form.get('category', 'Не указано'),
        'username': request.form.get('username', 'Аноним'),
        'votes': 0
    }
    photos.append(photo)
    photo_id_counter += 1
    
    return jsonify({'status': 'ok', 'photo_id': photo['id']})

@app.route('/photos', defaults={'category': None})
@app.route('/photos/<category>')
def get_photos(category):
    if category:
        filtered = [p for p in photos if p['category'] == category]
    else:
        filtered = photos
    # Возвращаем только нужные поля
    data = [{'id': p['id'], 'filename': p['filename'], 'votes': p['votes']} for p in filtered]
    return jsonify(data)

@app.route('/static/uploads/<filename>')
def uploaded_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)

if __name__ == "__main__":
    # Запуск локально на порту 5001
    app.run(debug=True, port=5001)
