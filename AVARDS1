import json
import os
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, WebAppInfo
from telegram.ext import Application, CommandHandler, MessageHandler, filters, CallbackContext

TOKEN = "YOUR_BOT_TOKEN"  # ← сюда вставь токен от @BotFather

# Пути к данным
PHOTOS_FILE = "data/photos.json"
VOTES_FILE = "data/votes.json"

# Создаём файлы, если их нет
os.makedirs("data", exist_ok=True)

if not os.path.exists(PHOTOS_FILE):
    with open(PHOTOS_FILE, "w") as f:
        json.dump([], f)

if not os.path.exists(VOTES_FILE):
    with open(VOTES_FILE, "w") as f:
        json.dump({}, f)

# Команда /start — кнопка для открытия Mini App
async def start(update: Update, context: CallbackContext):
    keyboard = [
        [InlineKeyboardButton(
            "Открыть Mini App",
            web_app=WebAppInfo(url="https://moldova2026.pythonanywhere.com/webapp/index.html")
        )]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text("Открой Mini App:", reply_markup=reply_markup)

# Обработка данных от Mini App
async def handle_webapp_data(update: Update, context: CallbackContext):
    data = json.loads(update.message.web_app_data.data)
    action = data.get("action")

    if action == "add_photo":
        await update.message.reply_text("Отправь фото своего питомца прямо сюда в чат.")
    elif action == "vote":
        # Показываем последнее фото
        with open(PHOTOS_FILE, "r") as f:
            photos = json.load(f)
        if not photos:
            await update.message.reply_text("Пока нет фото для голосования.")
            return
        last_photo = photos[-1]
        keyboard = [[InlineKeyboardButton("Проголосовать", callback_data="vote_yes")]]
        await update.message.reply_photo(
            photo=last_photo["file_id"],
            caption="Нравится это животное?",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )

# Получение фото от пользователя
async def receive_photo(update: Update, context: CallbackContext):
    user = update.message.from_user
    photo = update.message.photo[-1]
    file_id = photo.file_id

    with open(PHOTOS_FILE, "r") as f:
        photos = json.load(f)

    photos.append({
        "user_id": user.id,
        "username": user.username,
        "file_id": file_id
    })

    with open(PHOTOS_FILE, "w") as f:
        json.dump(photos, f, indent=2)

    await update.message.reply_text("Фото добавлено в голосование!")

# Главная функция
def main():
    app = Application.builder().token(TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.StatusUpdate.WEB_APP_DATA, handle_webapp_data))
    app.add_handler(MessageHandler(filters.PHOTO, receive_photo))

    print("Бот запущен...")
    app.run_polling()

if __name__ == "__main__":
    main()
