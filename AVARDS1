from flask import Flask, request, jsonify, send_from_directory
from telegram.ext import Updater, CommandHandler
import os
from threading import Thread

# ======== НАСТРОЙКИ ========
TOKEN = "8541224917:AAHPIVj9CCp1cQrXlMSB1Fs7rB3XvpntGMw"

# Файлы будут в одной директории с bot.py
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
UPLOAD_FOLDER = os.path.join(BASE_DIR, "uploads")
os.makedirs(UPLOAD_FOLDER, exist_ok=True)  # папка создаётся сама

app = Flask(__name__)

# ======== TELEGRAM БОТ ========
updater = Updater(TOKEN, use_context=True)
dispatcher = updater.dispatcher

def start(update, context):
    update.message.reply_text(
        "Бот запущен! Отправьте фото или откройте мини-приложение."
    )

dispatcher.add_handler(CommandHandler("start", start))

# ======== FLASK МАРШРУТЫ ========

# Главная страница
@app.route("/")
def index():
    return send_from_directory(BASE_DIR, "index.html")

# Раздача загруженных картинок
@app.route("/uploads/<filename>")
def uploaded_file(filename):
    return send_from_directory(UPLOAD_FOLDER, filename)

# Приём фото
@app.route("/upload", methods=["POST"])
def upload():
    if "photo" not in request.files:
        return jsonify({"error": "Файл не найден"}), 400
    file = request.files["photo"]
    if file.filename == "":
        return jsonify({"error": "Пустое имя файла"}), 400
    filepath = os.path.join(UPLOAD_FOLDER, file.filename)
    file.save(filepath)
    return jsonify({"success": True, "filename": file.filename})

# Список фото для голосования
@app.route("/photos", methods=["GET"])
def photos():
    files = os.listdir(UPLOAD_FOLDER)
    images = [f for f in files if f.lower().endswith((".png", ".jpg", ".jpeg", ".webp"))]
    # возвращаем относительные пути, чтобы JS мог их подставить
    return jsonify(images)

# ======== ЗАПУСК ========
if __name__ == "__main__":
    def run_flask():
        app.run(host="0.0.0.0", port=5000)

    Thread(target=run_flask).start()

    print("Telegram бот запущен...")
    updater.start_polling()
    updater.idle()
