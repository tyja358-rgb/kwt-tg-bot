from flask import Flask, request
from dotenv import load_dotenv
import os
import requests
import openai

# --- Загружаем .env ---
load_dotenv("/home/ArgoAetherium/Aetherium/.env")

# --- Токены ---
TELEGRAM_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
OPENAI_KEY = os.getenv("OPENAI_API_KEY")
openai.api_key = OPENAI_KEY
BASE_URL = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}"

# --- Flask-приложение ---
app = Flask(__name__)

# Главная страница для проверки
@app.route("/", methods=["GET"])
def index():
    return "Welcome to your Aetherium Web App!"

# ==== ВСТАВЛЯЙ СЮДА ====
# Новый маршрут для Web App кнопки в Telegram
@app.route("/webapp", methods=["GET"])
def webapp():
    return """
    <html>
        <head><title>Aetherium Web App</title></head>
        <body style="font-family: Arial; text-align: center; margin-top: 50px;">
            <h1>Добро пожаловать в Aetherium Web App!</h1>
            <p>Здесь можно запускать миниап через бота Telegram.</p>
        </body>
    </html>
    """
# ==== ВСТАВЛЯЙ СЮДА ====

# Webhook Telegram
@app.route("/webhook", methods=["POST"])
def webhook():
    update = request.get_json()
    if not update:
        return "no update", 400

    message = update.get("message")
    if message:
        chat_id = message["chat"]["id"]
        text = message.get("text", "")

        # Получаем ответ от GPT
        reply_text = get_gpt_response(text)
        send_message(chat_id, reply_text)

    return "ok", 200

# Функция отправки сообщений
def send_message(chat_id, text):
    url = f"{BASE_URL}/sendMessage"
    requests.post(url, json={"chat_id": chat_id, "text": text})

# Функция получения ответа GPT
def get_gpt_response(prompt):
    try:
        response = openai.ChatCompletion.create(
            model="gpt-4-mini",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7
        )
        return response.choices[0].message['content']
    except Exception as e:
        return f"Ошибка GPT: {e}"

# Локальный запуск для теста
if __name__ == "__main__":
    app.run(debug=True, port=5001)
