from flask import Flask, request, jsonify, send_from_directory
import os

app = Flask(__name__)

# Папка для загруженных фото
UPLOAD_FOLDER = 'static/uploads'
os.makedirs(UPLOAD_FOLDER, exist_ok=True)

# Список фото (в памяти для примера)
photos = []

# Главная страница
@app.route('/')
def index():
    return 'Hello from Flask! Теперь с загрузкой фото!'

# Загрузка фото
@app.route('/upload', methods=['POST'])
def upload():
    file = request.files.get('photo')
    category = request.form.get('category', 'Без категории')
    username = request.form.get('username', 'Аноним')
    if not file:
        return jsonify({'status': 'error', 'message': 'Файл не выбран'})
    
    filename = f"{len(photos)+1}_{file.filename}"
    filepath = os.path.join(UPLOAD_FOLDER, filename)
    file.save(filepath)
    
    photo_entry = {
        'id': len(photos)+1,
        'filename': filename,
        'category': category,
        'username': username,
        'votes': 0
    }
    photos.append(photo_entry)
    
    return jsonify({'status': 'ok', 'photo_id': photo_entry['id']})

# Получение фото
@app.route('/photos')
@app.route('/photos/<category>')
def get_photos(category=None):
    if category:
        filtered = [p for p in photos if p['category'] == category]
    else:
        filtered = photos
    return jsonify(filtered)

# Отдача файлов
@app.route('/static/uploads/<filename>')
def uploaded_file(filename):
    return send_from_directory(UPLOAD_FOLDER, filename)
