from flask import Flask, request, jsonify, send_from_directory
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters
import os

# ====== Настройка Flask ======
app = Flask(__name__)
UPLOAD_FOLDER = os.path.join(os.path.dirname(__file__), "uploads")
os.makedirs(UPLOAD_FOLDER, exist_ok=True)

# Хранение всех фото для ленты
photo_list = []

@app.route("/upload", methods=["POST"])
def upload_photo():
    file = request.files.get("photo")
    if not file:
        return jsonify({"status": "error", "message": "No file"}), 400

    filepath = os.path.join(UPLOAD_FOLDER, file.filename)
    file.save(filepath)

    # Сохраняем путь для ленты
    photo_list.append(file.filename)
    return jsonify({"status": "ok", "filename": file.filename})

@app.route("/photos", methods=["GET"])
def get_photos():
    return jsonify(photo_list)

@app.route("/uploads/<filename>")
def serve_photo(filename):
    return send_from_directory(UPLOAD_FOLDER, filename)

# ====== Настройка Telegram бота ======
TOKEN = "ВАШ_ТОКЕН_ТЕЛЕГРАМ"  # вставьте сюда токен
updater = Updater(TOKEN, use_context=True)
dispatcher = updater.dispatcher

def start(update, context):
    update.message.reply_text("Бот запущен!")

dispatcher.add_handler(CommandHandler("start", start))

# ====== Запуск ======
if __name__ == "__main__":
    from threading import Thread

    # Запуск Flask в отдельном потоке
    def run_flask():
        app.run(host="0.0.0.0", port=5000)

    Thread(target=run_flask).start()

    # Запуск Telegram бота
    print("Бот запущен...")
    updater.start_polling()
    updater.idle()
