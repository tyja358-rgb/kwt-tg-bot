<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>KWT Mini App Prototype</title>

<meta name="viewport"
      content="width=device-width,
               initial-scale=1.0,
               maximum-scale=1.0,
               user-scalable=no">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
html, body {
    margin:0;
    padding:0;
    height:100%;
    font-family: Arial, sans-serif;
    background:#12001f;
    color:#fff;
    touch-action: manipulation;
}

h1 { text-align:center; margin:10px 0; }

#map {
    width:100%;
    height:60vh;
    display:none;
    border:2px solid gold;
}

.controls { text-align:center; margin:5px; }

.btn {
    margin:5px;
    padding:10px 20px;
    background:#4CAF50;
    color:white;
    border:none;
    cursor:pointer;
}

#message {
    color:#6cff6c;
    font-weight:bold;
    text-align:center;
    margin-top:10px;
}

/* ===== –î–ñ–û–ô–°–¢–ò–ö ===== */
#joystick-container {
    position:fixed;
    bottom:30px;
    left:50%;
    transform:translateX(-50%);
    width:160px;
    height:160px;
    border-radius:50%;
    background:rgba(255,255,255,0.1);
    display:flex;
    justify-content:center;
    align-items:center;
    touch-action:none;
    z-index:10000;
}

#joystick {
    width:80px;
    height:80px;
    border-radius:50%;
    background:rgba(255,255,255,0.4);
    position:relative;
    touch-action:none;
}

/* ===== –°–ü–õ–≠–® ===== */
#splash-img {
    position:fixed;
    inset:0;
    width:100vw;
    height:100vh;
    object-fit:cover;
    z-index:9999;
}
</style>
</head>

<body>

<h1>KWT Mini App Prototype</h1>

<div class="controls">
    <button id="watch-ad-btn" class="btn">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∫–ª–∞–º—É</button>
    <p>–ú–æ—â–Ω–æ—Å—Ç—å –≤ –∫–∞–±–∏–Ω–µ—Ç–µ: <span id="power-total">0</span> –≤–∞—Ç</p>
</div>

<p id="message"></p>
<div id="map"></div>

<div id="joystick-container">
    <div id="joystick"></div>
</div>

<img id="splash-img"
     src="https://via.placeholder.com/500x500.png?text=KWT+Splash">

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// ================== –ò–°–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï ==================
const baseLat = 47.0100;
const baseLng = 28.8638;

let playerLat = baseLat;
let playerLng = baseLng;

let playerPower = 0;
let playerAds = 0;

const STEP_DEGREE = (100 / 111320) / 1200;
let moveX = 0;
let moveY = 0;

let map, userMarker;
let points = [];
let activePoint = null;
let movingToPoint = false;

// ================== SPLASH ==================
function showSplashThenMap(){
    const splash = document.getElementById('splash-img');
    splash.style.display = 'block';

    setTimeout(()=>{
        splash.style.display = 'none';
        document.getElementById('map').style.display = 'block';
        initMap();
    },3000);
}

// ================== MAP ==================
function initMap(){
    map = L.map('map').setView([playerLat, playerLng], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        maxZoom:19
    }).addTo(map);

    userMarker = L.marker([playerLat,playerLng])
        .addTo(map)
        .bindPopup("–í—ã –∑–¥–µ—Å—å")
        .openPopup();

    generatePoints();
}

// ================== –¢–û–ß–ö–ò ==================
function generatePoints() {
    points = [];
    const TOTAL_POINTS = 50; // –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ
    const COLORS = ['#00ff99','#ffd700','#ff5555','#00aaff','#cc66ff'];

    for(let i=0; i<TOTAL_POINTS; i++){
        const distMeters = Math.random()*1000 + 50;
        const distDeg = distMeters / 111320;
        const angle = Math.random() * Math.PI * 2;

        const lat = baseLat + distDeg * Math.cos(angle);
        const lng = baseLng + distDeg * Math.sin(angle);

        const marker = L.circleMarker([lat,lng],{
            radius:6,
            color:COLORS[i % COLORS.length],
            fillOpacity:0.9
        }).addTo(map);

        const point = {lat, lng, marker, collected:false, power: Math.floor(distMeters/10), adsRequired:1};
        points.push(point);

        marker.on('click', ()=> openPointModal(point));
    }
}

// ================== –û–¢–ö–†–´–¢–¨ –ú–û–î–ê–õ ==================
function openPointModal(point){
    activePoint = point;
    movingToPoint = false;

    const d = distance(playerLat, playerLng, point.lat, point.lng);
    const adsNeeded = Math.ceil(d / 100);
    point.adsRequired = adsNeeded;

    document.getElementById('pm-info').textContent =
        `–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ç–æ—á–∫–∏: ${Math.round(d)} –º. –ù—É–∂–Ω–æ —Ä–µ–∫–ª–∞–º—ã: ${adsNeeded}`;

    document.getElementById('point-modal').style.display = 'flex';

    const adBtn = document.getElementById('pm-ad-btn');
    adBtn.onclick = ()=>{
        playerAds++;
        if(playerAds >= point.adsRequired){
            point.collected = true;
            playerPower += point.power;
            document.getElementById('power-total').textContent = playerPower;
            map.removeLayer(point.marker);
            document.getElementById('point-modal').style.display = 'none';
            movingToPoint = true;
            activePoint = null;
        } else {
            alert(`–ù—É–∂–Ω–æ –µ—â—ë ${point.adsRequired - playerAds} —Ä–µ–∫–ª–∞–º—ã`);
        }
    }
}

function closePointModal(){
    document.getElementById('point-modal').style.display='none';
}

// ================== –î–ñ–û–ô–°–¢–ò–ö ==================
const joystick = document.getElementById('joystick');
const container = document.getElementById('joystick-container');
let dragging = false;

function updateVector(dx, dy){
    const len = Math.hypot(dx,dy);
    if(len===0){moveX=0; moveY=0; return;}
    moveX = (dx/len)*STEP_DEGREE;
    moveY = (-dy/len)*STEP_DEGREE;
}

joystick.addEventListener('pointerdown', ()=>dragging=true);
document.addEventListener('pointerup', ()=>{
    dragging=false;
    joystick.style.transform='translate(0,0)';
    updateVector(0,0);
});
document.addEventListener('pointermove', e=>{
    if(!dragging) return;
    const r = container.getBoundingClientRect();
    const cx = r.left + r.width/2;
    const cy = r.top + r.height/2;

    let dx = e.clientX - cx;
    let dy = e.clientY - cy;

    const max = r.width/2 - 40;
    const dist = Math.min(Math.hypot(dx,dy), max);
    const ang = Math.atan2(dy,dx);
    dx = dist*Math.cos(ang);
    dy = dist*Math.sin(ang);

    joystick.style.transform=`translate(${dx}px,${dy}px)`;
    updateVector(dx,dy);
});

// ================== –î–í–ò–ñ–ï–ù–ò–ï –° –ê–í–¢–û–°–ë–û–†–û–ú ==================
setInterval(()=>{
    if(movingToPoint && activePoint){
        const d = distance(playerLat, playerLng, activePoint.lat, activePoint.lng);
        if(d<5){
            activePoint.collected=true;
            playerPower+=activePoint.power;
            document.getElementById('power-total').textContent = playerPower;
            map.removeLayer(activePoint.marker);
            movingToPoint=false;
            activePoint=null;
        } else {
            const dx = activePoint.lng - playerLng;
            const dy = activePoint.lat - playerLat;
            const dist = Math.hypot(dx,dy);
            playerLat += (dy/dist)*STEP_DEGREE*1200;
            playerLng += (dx/dist)*STEP_DEGREE*1200;
            userMarker.setLatLng([playerLat,playerLng]);
            map.setView([playerLat,playerLng], map.getZoom(), {animate:false});
        }
    } else {
        playerLat += moveY;
        playerLng += moveX;
        userMarker.setLatLng([playerLat,playerLng]);
        map.setView([playerLat,playerLng], map.getZoom(), {animate:false});
    }
},50);

// ================== –†–ï–ö–õ–ê–ú–ê ==================
document.getElementById('watch-ad-btn').onclick = ()=>{
    playerAds++;
    for(const p of points){
        if(p.collected) continue;
        const d = distance(playerLat,playerLng,p.lat,p.lng);
        if(d<15 && playerAds>=p.adsRequired){
            p.collected=true;
            playerPower+=p.power;
            document.getElementById('power-total').textContent=playerPower;
            map.removeLayer(p.marker);
        }
    }
};

// ================== –†–ê–°–°–¢–û–Ø–ù–ò–ï ==================
function distance(lat1,lon1,lat2,lon2){
    const R=6371000;
    const dLat=(lat2-lat1)*Math.PI/180;
    const dLon=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(dLat/2)**2+
            Math.cos(lat1*Math.PI/180)*
            Math.cos(lat2*Math.PI/180)*
            Math.sin(dLon/2)**2;
    return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

// ================== –°–¢–ê–†–¢ ==================
showSplashThenMap();
</script>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –¢–û–ß–ö–ò -->
<div id="point-modal" style="
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.7);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:20000;
">
  <div style="
      background:#1b002b;
      padding:20px;
      border-radius:12px;
      width:90%;
      max-width:320px;
      text-align:center;
      border:2px solid gold;
  ">
    <h3>üìç –≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∞—è —Ç–æ—á–∫–∞</h3>
    <p id="pm-info">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ—á–∫–µ</p>
    <button class="btn" id="pm-ad-btn">–°–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∫–ª–∞–º—É</button>
    <button class="btn" onclick="closePointModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>
</body>
</html>
