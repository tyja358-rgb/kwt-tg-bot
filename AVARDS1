def handle_request(user_text, role=None):
    """
    role: "user", "programmer" или None
    """
    OPENAI_KEY = os.getenv("OPENAI_API_KEY")
    if not OPENAI_KEY:
        return "Ошибка: OPENAI_API_KEY не задан!"
    client = OpenAI(api_key=OPENAI_KEY)

    reply_prefix = ""

    # -------------------------
    # Проверка на команду создания папки
    # -------------------------
    if user_text.lower().startswith("создай папку"):
        try:
            # Разделяем команду и остальной текст
            parts = user_text.split(" ", 2)  # ["создай", "папку", "docs/reports/2026 ..."]
            if len(parts) < 3:
                return "Ошибка: не указан путь папки."
            
            # Первый "кусок" после команды воспринимаем как путь
            folder_and_rest = parts[2].strip()
            folder_path = folder_and_rest.split()[0]  # первый кусок — путь

            # Всё остальное — обычный текст запроса к ассистенту
            remaining_text = " ".join(folder_and_rest.split()[1:]).strip()
            
            # Корень проекта (обязательно полный путь)
            project_root = "/home/ArgoAetherium/Aetherium"
            full_path = os.path.join(project_root, folder_path)

            # Создаём все вложенные папки реально на диске
            os.makedirs(full_path, exist_ok=True)
            if os.path.exists(full_path):
                reply_prefix = f"Папка '{folder_path}' успешно создана на диске ✅\nПолный путь: {full_path}\n"
            else:
                reply_prefix = f"Не удалось создать папку '{folder_path}' ❌\n"
            
            # Если нет дополнительного текста, сразу возвращаем сообщение
            if not remaining_text:
                return reply_prefix

            # Используем остаток текста как новый user_text для диалога
            user_text = remaining_text

        except Exception as e:
            return f"Ошибка при создании папки: {e}"

    # -------------------------
    # Автоопределение роли
    # -------------------------
    if role is None:
        code_triggers = ["функция", "код", "python", "пример", "скрипт", "программа"]
        if any(word.lower() in user_text.lower() for word in code_triggers):
            role = "programmer"
        else:
            role = "user"

    # -------------------------
    # Используем системное сообщение из памяти
    # -------------------------
    system_msg = memory["programmer_system_msg"] if role == "programmer" else memory["user_system_msg"]

    # -------------------------
    # Формируем контекст из последних 20 сообщений
    # -------------------------
    history_key = "default"
    history = chat_history.get(history_key, [])
    history.append({"role": "user", "content": user_text})
    if len(history) > 20:
        history = history[-20:]

    # -------------------------
    # Создание запроса к OpenAI
    # -------------------------
    messages = [{"role": "system", "content": system_msg}] + history
    resp = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=messages,
        temperature=0.7
    )
    reply_text = resp.choices[0].message.content

    # -------------------------
    # Сохраняем ответ в историю
    # -------------------------
    history.append({"role": "assistant", "content": reply_text})
    chat_history[history_key] = history
    save_history()

    # Возвращаем сообщение о создании папки + ответ ассистента
    return reply_prefix + reply_text
