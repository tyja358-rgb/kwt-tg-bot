import os
from flask import request

UPLOAD_FOLDER = 'static/uploads'
if not os.path.exists(UPLOAD_FOLDER):
    os.makedirs(UPLOAD_FOLDER)

@app.route('/upload', methods=['POST'])
def upload():
    file = request.files.get('photo')
    category = request.form.get('category')

    if not file or not category:
        return jsonify({'status': 'error', 'message': 'Нет файла или категории'})

    # Определяем id для фото
    conn = sqlite3.connect('moldova_pet_awards.db')
    c = conn.cursor()
    c.execute("INSERT INTO photos (user_id, category, upload_date) VALUES (?, ?, ?)", (0, category, date.today()))
    photo_id = c.lastrowid
    conn.commit()
    conn.close()

    # Сохраняем файл
    filename = f"{photo_id}.jpg"
    filepath = os.path.join(UPLOAD_FOLDER, filename)
    file.save(filepath)

    return jsonify({'status': 'ok', 'photo_id': photo_id})
