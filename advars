# Aetherium/app.py
from bots.personal_bot.bot import handle_request
from flask import Flask, request, jsonify, render_template
from dotenv import load_dotenv
import os
import requests
from openai import OpenAI
from werkzeug.utils import secure_filename

# =========================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞
# =========================
load_dotenv("/home/ArgoAetherium/Aetherium/.env")

TELEGRAM_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
OPENAI_KEY = os.getenv("OPENAI_API_KEY")
BASE_URL = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}"

client = OpenAI(api_key=OPENAI_KEY)

app = Flask(__name__)

UPLOAD_FOLDER = "uploads"
os.makedirs(UPLOAD_FOLDER, exist_ok=True)
app.config["UPLOAD_FOLDER"] = UPLOAD_FOLDER

# =========================
# Root (–ø—Ä–æ–≤–µ—Ä–∫–∞)
# =========================
@app.route("/", methods=["GET"])
def index_root():
    return "Aetherium server is running ‚úÖ"

# =========================
# MiniApp Web
# =========================
@app.route("/webapp", methods=["GET"])
def webapp():
    return """
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Aetherium AI Chat + Voice</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial; background: #f5f5f5; display: flex; flex-direction: column; align-items: center; margin:0; padding:10px; }
#chat { width:100%; max-width:420px; height:60vh; background:white; border-radius:10px; padding:10px; overflow-y:auto; }
.msg { margin:6px 0; padding:8px 12px; border-radius:14px; max-width:80%; }
.user { background:#d1e7ff; align-self:flex-end; }
.ai { background:#e2ffe2; align-self:flex-start; }
#inputBox { width:100%; max-width:420px; display:flex; margin-top:10px; }
input { flex:1; padding:10px; border-radius:8px; border:1px solid #ccc; }
button { margin-left:6px; padding:10px 14px; border-radius:8px; border:none; background:#4CAF50; color:white; font-weight:bold; }
</style>
</head>
<body>
<h2>Aetherium AI ü§ñ</h2>
<div id="chat"></div>
<div id="inputBox">
<input id="text" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
<button onclick="send()">‚ñ∂</button>
<button id="recordBtn">üé§</button>
</div>

<script>
const chat=document.getElementById("chat");
const input=document.getElementById("text");
const recordBtn=document.getElementById("recordBtn");
let stream, mediaRecorder, audioChunks=[], isRecording=false;

function add(text,cls){
    const d=document.createElement("div");
    d.className="msg "+cls;
    d.innerText=text;
    chat.appendChild(d);
    chat.scrollTop=chat.scrollHeight;
}

async function send(){
    const text=input.value.trim();
    if(!text) return;
    add(text,"user"); input.value="";
    add("üß† –î—É–º–∞—é...","ai");
    try{
        const res=await fetch("/ask_ai",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({message:text})
        });
        const data=await res.json();
        chat.lastChild.innerText=data.reply;
    }catch(e){chat.lastChild.innerText="–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è";}
}

input.addEventListener("keypress", e=>{if(e.key==="Enter") send();});

// === Voice recording ===
async function initMic(){
    if(stream) return;
    stream=await navigator.mediaDevices.getUserMedia({audio:true});
}

recordBtn.addEventListener("click", async ()=>{
    try{
        await initMic();
        if(!isRecording){
            audioChunks=[];
            mediaRecorder=new MediaRecorder(stream);
            mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
            mediaRecorder.start();
            isRecording=true;
            recordBtn.innerText="‚èπ";
        }else{
            mediaRecorder.stop();
            isRecording=false;
            recordBtn.innerText="üé§";
            mediaRecorder.onstop=async ()=>{
                const blob=new Blob(audioChunks,{type:"audio/webm"});
                const formData=new FormData();
                formData.append("file",blob,"voice.webm");

                add("üé§ –ì–æ–≤–æ—Ä—é‚Ä¶","user");
                add("üß† –†–∞—Å–ø–æ–∑–Ω–∞—é‚Ä¶","ai");

                try{
                    const res=await fetch("/whisper",{method:"POST",body:formData});
                    const data=await res.json();
                    chat.lastChild.innerText=data.text || "–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª";
                    if(data.text){
                        const aiRes=await fetch("/ask_ai",{
                            method:"POST",
                            headers:{"Content-Type":"application/json"},
                            body:JSON.stringify({message:data.text})
                        });
                        const aiData=await aiRes.json();
                        add(aiData.reply,"ai");
                    }
                }catch(e){chat.lastChild.innerText="–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è";}
            };
        }
    }catch(e){alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É");}
});
</script>
</body>
</html>
"""

# =========================
# Whisper endpoint
# =========================
@app.route("/whisper", methods=["POST"])
def whisper():
    if "file" not in request.files:
        return jsonify({"text":""})
    file=request.files["file"]
    filename=secure_filename(file.filename)
    path=os.path.join(app.config["UPLOAD_FOLDER"],filename)
    file.save(path)

    try:
        with open(path,"rb") as audio_file:
            transcription = client.audio.transcriptions.create(model="whisper-1", file=audio_file)
        os.remove(path)
        return jsonify({"text":transcription.text})
    except Exception as e:
        return jsonify({"text":f"–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: {e}"}),500

# =========================
# AI endpoint
# =========================
@app.route("/ask_ai", methods=["POST"])
def ask_ai():
    user_text=request.get_json().get("message","")
    try:
        resp=client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role":"system","content":"–¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π AI –ø–æ–º–æ—â–Ω–∏–∫ –ø—Ä–æ–µ–∫—Ç–∞ Aetherium."},
                {"role":"user","content":user_text}
            ],
            temperature=0.7
        )
        return jsonify({"reply":resp.choices[0].message.content})
    except Exception as e:
        return jsonify({"reply":f"–û—à–∏–±–∫–∞ AI: {e}"}),500

# =========================
# Telegram webhook
# =========================
@app.route("/webhook", methods=["POST"])
def webhook():
    update=request.get_json()
    if not update: return "no update",400
    message=update.get("message")
    if message:
        chat_id=message["chat"]["id"]
        text=message.get("text","")
        if text:
            try:
                resp=client.chat.completions.create(
                    model="gpt-4o-mini",
                    messages=[
                        {"role":"system","content":"–¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π AI –ø–æ–º–æ—â–Ω–∏–∫ –ø—Ä–æ–µ–∫—Ç–∞ Aetherium."},
                        {"role":"user","content":text}
                    ],
                    temperature=0.7
                )
                reply_text=resp.choices[0].message.content
            except Exception as e:
                reply_text=f"–û—à–∏–±–∫–∞ AI: {e}"
            requests.post(f"{BASE_URL}/sendMessage",json={"chat_id":chat_id,"text":reply_text})
    return "ok",200

# =========================
# –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫
# =========================
if __name__=="__main__":
    app.run(debug=True,port=5001)
