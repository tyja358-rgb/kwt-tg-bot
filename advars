const baseLat = 47.0100, baseLng = 28.8638;
let playerLat = baseLat, playerLng = baseLng, playerPower = 0, playerAds = 0;
const STEP_DEGREE = (100 / 111320) / 1200;
let moveX = 0, moveY = 0;
let map = null;
let userMarker = null;
let points = [];
let activePoint = null;
let movingToPoint = false;
let playerCash = 0;
let myStationsCount = 0;

// --- ID игрока ---
let playerId = null;
let mapReady = false;

// ===== Исправленная initApp =====
function initApp() {
    console.log("initApp запущен");
    showSplashThenMap(); // запускаем splash + карту
}

// ===== initAppSafe (оставляем без изменений) =====
function initAppSafe() {
    try {
        initApp();
    } catch(e){
        console.error("Ошибка инициализации:", e);
    }
}

// ===== Запуск приложения =====
if (window.Telegram && window.Telegram.WebApp) {
    const tg = window.Telegram.WebApp;

    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
        playerId = tg.initDataUnsafe.user.id;
        console.log("Telegram ID:", playerId);
        initAppSafe();
    } else {
        console.warn("Telegram есть, но данные пользователя не получены");
        initAppSafe(); // запуск для теста без Telegram ID
    }
} else {
    console.warn("Не в Telegram WebApp");
    initAppSafe(); // запуск для теста без Telegram ID
}

// ===== Splash экран и карта =====
async function showSplashThenMap(){
    const splash = document.getElementById('splash-img');
    splash.style.display='block';
    setTimeout(async ()=>{
        splash.style.display='none';
        const mapDiv = document.getElementById('map');
        mapDiv.style.display='block';
        requestAnimationFrame(() => initMap());
        await loadPlayerPower();
    },3000);
}

function initMap() {
    if (map) return; // если карта уже создана

    map = L.map('map', { zoomControl: true, attributionControl: true })
           .setView([playerLat, playerLng], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        crossOrigin: true
    }).addTo(map);

    userMarker = L.marker([playerLat, playerLng])
                  .addTo(map)
                  .bindPopup("Вы здесь");

    generatePoints();
    loadStations();

    setTimeout(() => {
        map.invalidateSize(true);
        mapReady = true; // ✅ карта готова
    }, 300);
}

// ===== Джойстик =====
const joystick=document.getElementById('joystick'), container=document.getElementById('joystick-container');
let dragging=false;
function updateVector(dx,dy){ const len=Math.hypot(dx,dy); if(len===0){moveX=0; moveY=0; return;} moveX=(dx/len)*STEP_DEGREE; moveY=(-dy/len)*STEP_DEGREE; }
joystick.addEventListener('pointerdown',()=>dragging=true);
document.addEventListener('pointerup',()=>{ dragging=false; joystick.style.transform='translate(0,0)'; updateVector(0,0); });
document.addEventListener('pointermove',e=>{ if(!dragging) return; const r=container.getBoundingClientRect(); const cx=r.left+r.width/2, cy=r.top+r.height/2; let dx=e.clientX-cx, dy=e.clientY-cy; const max=r.width/2-40, dist=Math.min(Math.hypot(dx,dy),max), ang=Math.atan2(dy,dx); dx=dist*Math.cos(ang); dy=dist*Math.sin(ang); joystick.style.transform=`translate(${dx}px,${dy}px)`; updateVector(dx,dy); });

// ===== Интервал движения игрока =====
setInterval(()=>{
    if(!mapReady) return; // ждём, пока карта готова

    if(movingToPoint && activePoint){
        const d=distance(playerLat,playerLng,activePoint.lat,activePoint.lng);
        if(d<5){
            activePoint.collected=true;
            playerPower+=activePoint.power;
            document.getElementById('power-total').textContent=playerPower.toFixed(1);
            savePlayerPower();
            if(activePoint.marker) map.removeLayer(activePoint.marker);
            movingToPoint=false;
            activePoint=null;
        } else {
            const dx=activePoint.lng-playerLng, dy=activePoint.lat-playerLat, dist=Math.hypot(dx,dy), speed=0.02;
            playerLat+=(dy/dist)*STEP_DEGREE*1200*speed;
            playerLng+=(dx/dist)*STEP_DEGREE*1200*speed;
            if(userMarker) userMarker.setLatLng([playerLat,playerLng]);
            map.setView([playerLat,playerLng], map.getZoom(),{animate:false});
        }
    } else {
        playerLat+=moveY;
        playerLng+=moveX;
        if(userMarker) userMarker.setLatLng([playerLat,playerLng]);
        map.setView([playerLat,playerLng], map.getZoom(),{animate:false});
    }
},50);

// ===== Остальной код (точки, станции, сбор точек, реклама, load/save power) =====
// сюда вставляй твои функции generatePoints, loadStations, collectPoint, openPointModal и т.д.
// Они остаются без изменений из твоего оригинального main.js
