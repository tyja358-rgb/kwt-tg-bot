from assistant.assistant import handle_request as handle_assistant_request
from flask import Flask, request, jsonify, render_template_string
from dotenv import load_dotenv
import os
from openai import OpenAI

load_dotenv("/home/ArgoAetherium/Aetherium/.env")

OPENAI_KEY = os.getenv("OPENAI_API_KEY")
if not OPENAI_KEY:
    raise ValueError("OPENAI_API_KEY –Ω–µ –∑–∞–¥–∞–Ω!")

client = OpenAI(api_key=OPENAI_KEY)

app = Flask(__name__)
UPLOAD_FOLDER = "uploads"
os.makedirs(UPLOAD_FOLDER, exist_ok=True)
app.config["UPLOAD_FOLDER"] = UPLOAD_FOLDER

@app.route("/", methods=["GET"])
def index_root():
    return "Aetherium server is running ‚úÖ"

@app.route("/ask_ai", methods=["POST"])
def ask_ai():
    data = request.get_json()
    text = data.get("message", "")
    # –ü–µ—Ä–µ–¥–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π user_id –¥–ª—è —Ç–µ—Å—Ç–∞
    user_id = data.get("user_id", 8145632503)
    reply = handle_assistant_request(text, user_id)
    return jsonify({"reply": reply})

@app.route("/webapp", methods=["GET"])
def webapp():
    html = """
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Aetherium AI Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial; background: #f5f5f5; display:flex; flex-direction: column; align-items:center; margin:0; padding:10px;}
#chat { width:100%; max-width:420px; height:60vh; background:white; border-radius:10px; padding:10px; overflow-y:auto;}
.msg { margin:6px 0; padding:8px 12px; border-radius:14px; max-width:80%;}
.user { background:#d1e7ff; align-self:flex-end;}
.ai { background:#e2ffe2; align-self:flex-start;}
#inputBox { width:100%; max-width:420px; display:flex; margin-top:10px;}
input { flex:1; padding:10px; border-radius:8px; border:1px solid #ccc;}
button { margin-left:6px; padding:10px 14px; border-radius:8px; border:none; background:#4CAF50; color:white; font-weight:bold;}
</style>
</head>
<body>
<h2>Aetherium AI ü§ñ</h2>
<div id="chat"></div>
<div id="inputBox">
<input id="text" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
<button onclick="send()">‚ñ∂</button>
</div>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("text");

// –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π user_id –¥–ª—è —Ç–µ—Å—Ç–∞
const user_id = 8145632503;

function add(text, cls) {
    const d = document.createElement("div");
    d.className = "msg " + cls;
    d.innerText = text;
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;
}

async function send() {
    const text = input.value.trim();
    if (!text) return;
    add(text, "user");
    input.value = "";
    add("üß† –î—É–º–∞—é...", "ai");

    try {
        const res = await fetch("/ask_ai", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({message: text, user_id: user_id})
        });
        const data = await res.json();
        chat.lastChild.innerText = data.reply;
    } catch(e) {
        chat.lastChild.innerText = "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è";
    }
}

input.addEventListener("keypress", e => { if (e.key === "Enter") send(); });
</script>
</body>
</html>
"""
    return render_template_string(html)

if __name__=="__main__":
    app.run(debug=True, port=5002)
